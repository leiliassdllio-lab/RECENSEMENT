<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recense un HÃ©risson</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { font-family: 'Arial', sans-serif; background-color: #f7f9f7; margin:0; padding:0; }
  header, footer { background-color: #4CAF50; color:white; text-align:center; padding:10px 0; }
  .container { width:90%; max-width:800px; margin:20px auto; background-color:white; border-radius:10px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.2); position: relative; }
  h2 { text-align:center; color:#4CAF50; margin-bottom:20px; }
  form p { margin:15px 0 5px; font-weight:bold; }
  input, select, textarea, button { width:100%; padding:10px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
  button { background-color:#4CAF50; color:white; font-weight:bold; border:none; cursor:pointer; margin-top:15px; transition: background 0.3s; }
  button:hover { background-color: #43a047; }
  #map { height:300px; border-radius:10px; margin-bottom:20px; }
  .icon-label { display:flex; align-items:center; gap:10px; font-weight:normal; }
  .icon-label span { font-size:1.5em; }
  .tree { position:absolute; font-size:2em; opacity:0.4; }
  .tree1 { top:10px; left:10px; }
  .tree2 { bottom:10px; right:20px; }
  .tree3 { top:50px; right:50px; }
  #preview img { max-width:100%; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.2); margin-top:10px; }
  .faq-container { background-color: #e8f5e9; border-left:5px solid #4CAF50; padding:15px 20px; margin-top:25px; border-radius:8px; }
  .faq-container h2 { font-size:1.3em; color:#2e7d32; text-align:left; margin-bottom:10px; }
  .faq-container ul { list-style-type:none; padding-left:0; }
  .faq-container li { margin-bottom:10px; font-size:1em; }
  .faq-container li span { margin-right:8px; }
</style>
</head>
<body>

<header>
  <h1>ğŸ¦” Recense un HÃ©risson</h1>
  <div class="container">
      <a href="main.html" class="btn">Retour Ã  l'accueil</a>
    </div>
</header>

<div class="container">
  <div class="tree tree1">ğŸŒ³</div>
  <div class="tree tree2">ğŸŒ²</div>
  <div class="tree tree3">ğŸŒ³</div>

  <h2>Localisation & Observation</h2>
  <div id="map"></div>

  <form id="recensementForm" name="recensement-herissons">
    <p class="icon-label"><span>ğŸ“</span> OÃ¹ avez-vous vu le hÃ©risson ?</p>
    <input type="text" name="lieu" id="lieu" placeholder="Adresse ou lieu prÃ©cis" required>

    <p class="icon-label"><span>ğŸ“…</span> Quand lâ€™avez-vous observÃ© ?</p>
    <input type="date" name="date" id="date" required>

    <p class="icon-label"><span>ğŸ”</span> Comment lâ€™avez-vous vu ?</p>
    <select name="methode" required>
      <option value="">--SÃ©lectionnez--</option>
      <option value="observatoire">Observation directe</option>
      <option value="camera">CamÃ©ra / piÃ¨ge photo</option>
      <option value="autre">Autre</option>
    </select>

    <p class="icon-label"><span>ğŸ“·</span> Ajouter une image / prendre une photo</p>
    <label for="photoUpload" style="display:flex; flex-direction:column; align-items:center; border:2px dashed #4CAF50; padding:15px; border-radius:10px; cursor:pointer;">
      <span style="font-size:2em;">ğŸ“¸</span>
      <span>Cliquer pour choisir ou prendre une photo</span>
    </label>
    <input type="file" id="photoUpload" accept="image/*" capture="environment" style="display:none;">
    <div id="preview"></div>

    <p class="icon-label"><span>ğŸ“</span> Notes supplÃ©mentaires</p>
    <textarea name="notes" placeholder="Ajoutez vos remarques"></textarea>

    <button type="submit">Envoyer</button>
  </form>

  <div class="faq-container">
    <h2>ğŸ’¡ Conseils pour observer les hÃ©rissons</h2>
    <ul>
      <li><span>ğŸ¦”</span> Observez les hÃ©rissons de prÃ©fÃ©rence au crÃ©puscule ou la nuit.</li>
      <li><span>ğŸ”‡</span> Ã‰vitez de faire du bruit ou dâ€™allumer une lumiÃ¨re forte.</li>
      <li><span>ğŸ“·</span> Si vous prenez une photo, utilisez le flash avec prÃ©caution.</li>
      <li><span>ğŸ¡</span> Respectez lâ€™habitat naturel et ne dÃ©rangez pas les hÃ©rissons.</li>
      <li><span>ğŸ“</span> Notez toujours la localisation exacte et la date de votre observation.</li>
    </ul>
  </div>
</div>

<footer>
  Â© <span id="year"></span> â€“ Team HÃ©risson
</footer>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- ğŸ”¹ Firebase + Formulaire -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// --- Config Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyDxCMszTckBP5Zmiaxmo74aVNHiIhUYvys",
  authDomain: "herisson-f80ba.firebaseapp.com",
  projectId: "herisson-f80ba",
  storageBucket: "herisson-f80ba.firebasestorage.app",
  messagingSenderId: "142270421417",
  appId: "1:142270421417:web:cb3abd700fab6731c40cb8"
};

// --- Initialisation Firebase ---
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- PrÃ©-remplir la date ---
const dateInput = document.getElementById('date');
const today = new Date();
dateInput.value = today.toISOString().slice(0,10);

// --- Affichage annÃ©e dans footer ---
document.getElementById("year").textContent = today.getFullYear();

// --- Carte et gÃ©olocalisation ---
const map = L.map('map').setView([50.8467, 4.3525], 13);
L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

let marker;
function updateLieu(lat, lon){ document.getElementById('lieu').value = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`; }

if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    map.setView([lat, lon], 15);

    marker = L.marker([lat, lon], {draggable:true}).addTo(map)
      .bindPopup("Votre position actuelle. DÃ©placez le marqueur si nÃ©cessaire.").openPopup();

    updateLieu(lat, lon);

    marker.on('dragend', e=>{
      const p = e.target.getLatLng();
      updateLieu(p.lat, p.lng);
    });
  }, err=>{ alert("Impossible de rÃ©cupÃ©rer votre position : " + err.message); });
}

// --- PrÃ©visualisation image ---
const photoInput = document.getElementById('photoUpload');
const previewDiv = document.getElementById('preview');
photoInput.addEventListener('change', function(){
  const file = this.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e => previewDiv.innerHTML = `<img src="${e.target.result}">`;
    reader.readAsDataURL(file);
  }
});

// --- Soumission formulaire vers Firestore ---
const form = document.getElementById('recensementForm');
form.addEventListener('submit', async e=>{
  e.preventDefault();

  const recensement = {
    lieu: form.lieu.value,
    date: form.date.value,
    methode: form.methode.value,
    notes: form.notes.value
  };

  if(marker){
    const p = marker.getLatLng();
    recensement.latitude = p.lat;
    recensement.longitude = p.lng;
  }

  try {
    await addDoc(collection(db, "recensements"), recensement);
    alert("Recensement enregistrÃ© dans Firestore !");

    form.reset();
    previewDiv.innerHTML = "";
    if(marker) marker.setLatLng(map.getCenter());
    window.location.href = "confirmation.html";
  } catch (error) {
    console.error("Erreur lors de l'enregistrement :", error);
    alert("Impossible d'enregistrer le recensement. VÃ©rifiez la console.");
  }
});
</script>

</body>
</html>
